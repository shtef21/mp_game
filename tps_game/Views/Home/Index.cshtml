@{
    ViewData["Title"] = "Home Page";
}

<style>
    #game {
        width: 250px;
        height: 250px;
        margin: 0 auto;
        background: black;
        line-height: 0;
    }

    #game > div {
        display: inline-block;
        width: 25px;
        height: 25px;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        background: blue;
        border-right: 1px solid black;
        border-bottom: 1px solid black;
    }

    #game > div.is-player {
        background: green;
    }

    #game > div.is-enemy {
        background: red;
    }

    #game > div.is-teritory {
        opacity: 0.5;
    }

</style>

<div class="text-center mt-4">
    <h1 class="text-[2rem] font-bold">Welcome to the MP Game</h1>
</div>

<div id="loginForm">
    <form class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="username_i">
                Username
            </label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="username_i" type="text" placeholder="Username">
        </div>
        <div class="flex items-center justify-between">
            <button id="signInButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline disabled:opacity-75" type="button" disabled onclick="connect()">
                Connect
            </button>
        </div>
    </form>
</div>

<!-- GAME -->
<div id="game" class="hidden" tabindex="0">
</div>

<div class="ml-[100px]">
    <ul id="ulLog" class="list-none">
        <li>
            1. <strong><pre class="inline">Logs go here</pre></strong>
        </li>
    </ul>
</div>

<script>

    let pid = null;

    function addLog(txt) {
        let log = document.createElement('pre');
        let item = document.createElement('li');

        log.classList.add('inline');
        log.innerText = txt;
        item.innerText = (ulLog.children.length + 1) + '. ';
        item.insertAdjacentHTML('beforeend', '<strong>' + log.outerHTML + '</strong>');

        ulLog.insertAdjacentElement('afterbegin', item);
    }

    function drawSquare(posX, posY, squareClass) {
        let index = (posY - 1) * 10 + (posX - 1);
        console.log(index);
        game.children[index].classList.add(squareClass);
    }

    // Connect web socket
    function connect() {

        const myUsername = username_i.value;
        var url = 'wss://' + location.host;
        var usernameComponent = '?username=' + encodeURIComponent(myUsername);
        var socket = new WebSocket(url + usernameComponent);

        socket.addEventListener('open', function(event) {
            addLog('Connected to ' + url);
            loginForm.classList.add('hidden');
            game.classList.remove('hidden');

            game.onkeydown = function (event) {
                if (event.keyCode == 87) {
                    socket.send('W');
                }
                else if (event.keyCode == 65) {
                    socket.send('A');
                }
                else if (event.keyCode == 83) {
                    socket.send('S');
                }
                else if (event.keyCode == 68) {
                    socket.send('D');
                }
            }
        });

        socket.addEventListener('message', function(event) {
            addLog('Message from server: ' + event.data);
            console.log(event.data);
            handleMessage(event.data, myUsername);
        });

        socket.addEventListener('close', function(event) {
            addLog('Connection to ' + url + ' closed.');
            loginForm.classList.remove('hidden');
            game.classList.add('hidden');
            game.onkeydown = null;
        });
    }

    function resetMap(mapHeight, mapWidth) {

        game.dataset.height = mapHeight;
        game.dataset.width = mapWidth;

        // If needed, draw blocks in the game div
        while (game.children.length < mapHeight * mapWidth) {
            let block = document.createElement('div');
            game.insertAdjacentElement('beforeend', block);
        }

        // Clear all classes from blocks
        for (let child of game.children) {
            child.className = '';
        }
    }

    function handleMessage(msg, myUsername) {
        let obj = JSON.parse(msg);

        if (obj.type == 'ID') {
            pid = obj.ID;
        }
        else if (obj.type == 'map') {

            let mapWidth = obj.width;
            let mapHeight = obj.height;
            resetMap(mapHeight, mapWidth);

            let currRow = 0;
            let rows = obj.map.split('\n');
            
            for (let r of rows) {

                let currCol = 0;
                let cols = r.split(' ');

                for (let c of cols) {
                    
                    let mapIdx = currRow * mapWidth + currCol;
                    let gameBlock = game.children[mapIdx];

                    if (c == 'x') {
                        
                        // No man's land
                        gameBlock.className = '';
                    }
                    else if (c.split('-')[0] == 'p') {
                        
                        // This is a player
                        if (c.split('-')[1] == pid) {
                            gameBlock.classList.add('is-player');
                        }
                        else {
                            gameBlock.classList.add('is-enemy');
                        }
                    }
                    else if (c.split('-')[0] == 't') {
                        
                        // Get teritory owner
                        if (c.split('-')[1] == pid) {
                            gameBlock.classList.add('is-player');
                        }
                        else {
                            gameBlock.classList.add('is-enemy');
                        }
                        // This is player's teritory
                        gameBlock.classList.add('is-teritory');
                    }
                    currCol++;
                }

                currRow++;
            }
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {

        // Initialize the input form
        username_i.value = '';
        username_i.addEventListener('keyup', function() {
            if (username_i.value.length > 2) {
                signInButton.disabled = false;
            }
            else {
                signInButton.disabled = true;
            }
        });

    });

</script>